from datetime import datetime

from httpx import AsyncClient
from app.config import settings


async def bot_send_message(client: AsyncClient, chat_id: int, text: str, kb: list | None = None):
    send_data = {"chat_id": chat_id, "text": text, "parse_mode": "HTML"}
    if kb:
        send_data["reply_markup"] = {"inline_keyboard": kb}
    await client.post(f"{settings.get_tg_api_url()}/sendMessage", json=send_data)


async def call_answer(client: AsyncClient, callback_query_id: int, text: str):
    await client.post(f"{settings.get_tg_api_url()}/answerCallbackQuery", json={
        "callback_query_id": callback_query_id,
        "text": text
    })


def get_greeting_text(first_name: str):
    return f"""
üè• <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –∫–ª–∏–Ω–∏–∫–∏ "–ó–¥–æ—Ä–æ–≤—å–µ–ü–ª—é—Å"!</b>

–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, <b>{first_name}</b>! üëã

–ú—ã —Ä–∞–¥—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞—Å –≤ –Ω–∞—à–µ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–∞–ø–∏—Å–∏ –∫ –≤—Ä–∞—á–∞–º. –ó–¥–µ—Å—å –≤—ã —Å–º–æ–∂–µ—Ç–µ:

‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º –∫ –ª—é–±–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
üóì –£–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏
‚ÑπÔ∏è –ü–æ–ª—É—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—à–∏—Ö —É—Å–ª—É–≥–∞—Ö

<i>–í–∞—à–µ –∑–¥–æ—Ä–æ–≤—å–µ - –Ω–∞—à –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!</i>

–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é –Ω–∏–∂–µ üëá
"""


def get_about_text():
    return """
üè• <b>–û –∫–ª–∏–Ω–∏–∫–µ "–ó–¥–æ—Ä–æ–≤—å–µ–ü–ª—é—Å"</b>

–ú—ã - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–Ω–æ–≥–æ–ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —É—Å–ª—É–≥–∏ —Å 2005 –≥–æ–¥–∞.

<b>–ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</b>

‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ–ø—ã—Ç–Ω—ã—Ö –≤—Ä–∞—á–µ–π –≤—ã—Å—à–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
üèÜ –ù–æ–≤–µ–π—à–µ–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
üïí –£–¥–æ–±–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 8:00 –¥–æ 20:00
üè† –ö–æ–º—Ñ–æ—Ä—Ç–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞
üíâ –®–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —É—Å–ª—É–≥

<b>–ù–∞—à–∏ –æ—Ç–¥–µ–ª–µ–Ω–∏—è:</b>
‚Ä¢ –¢–µ—Ä–∞–ø–∏—è
‚Ä¢ –ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è
‚Ä¢ –ù–µ–≤—Ä–æ–ª–æ–≥–∏—è
‚Ä¢ –ì–∏–Ω–µ–∫–æ–ª–æ–≥–∏—è
‚Ä¢ –£—Ä–æ–ª–æ–≥–∏—è
‚Ä¢ –ü–µ–¥–∏–∞—Ç—Ä–∏—è
‚Ä¢ –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è

<i>–ú—ã –∑–∞–±–æ—Ç–∏–º—Å—è –æ –≤–∞—à–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –∏ –∫–æ–º—Ñ–æ—Ä—Ç–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –ª–µ—á–µ–Ω–∏—è!</i>

–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º –∏–ª–∏ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –Ω–∞—à–∏—Ö —É—Å–ª—É–≥–∞—Ö, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –º–µ–Ω—é –±–æ—Ç–∞.
"""


def get_booking_text(appointment_count):
    if appointment_count > 0:
        message_text = f"""
üìÖ <b>–í–∞—à–∏ –∑–∞–ø–∏—Å–∏ –∫ –≤—Ä–∞—á–∞–º</b>

–£ –≤–∞—Å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ <b>{appointment_count}</b> {pluralize_appointments(appointment_count)}.

–ß—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –≤–∞—à–∏—Ö –∑–∞–ø–∏—Å–µ–π, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å–∏" –Ω–∏–∂–µ.
"""
    else:
        message_text = """
üìÖ <b>–í–∞—à–∏ –∑–∞–ø–∏—Å–∏ –∫ –≤—Ä–∞—á–∞–º</b>

–í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è —É –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏–µ–º–æ–≤.

–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –≤—Ä–∞—á—É, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–Ω–æ–ø–∫–æ–π "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
"""
    return message_text


def pluralize_appointments(count: int) -> str:
    if count == 1:
        return "–ø—Ä–∏–µ–º"
    elif 2 <= count <= 4:
        return "–ø—Ä–∏–µ–º–∞"
    else:
        return "–ø—Ä–∏–µ–º–æ–≤"


def format_appointment(appointment, start_text="üóì <b>–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º</b>"):
    appointment_date = datetime.strptime(appointment['day_booking'], '%Y-%m-%d').strftime('%d.%m.%Y')
    return f"""
{start_text}

üìÖ –î–∞—Ç–∞: {appointment_date}
üïí –í—Ä–µ–º—è: {appointment['time_booking']}
üë®‚Äç‚öïÔ∏è –í—Ä–∞—á: {appointment['doctor_full_name']}
üè• –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: {appointment['special']}

‚ÑπÔ∏è –ù–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏: {appointment['id']}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞ 10-15 –º–∏–Ω—É—Ç –¥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
"""
